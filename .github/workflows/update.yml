name: Update YouTube Streams Data

on:
  schedule:
    # â˜€ï¸ 15åˆ†ã”ã¨ã®è»½é‡æ›´æ–°ï¼ˆJST 11:00ã€œç¿Œ2:00 â†’ UTC 2ã€œ17æ™‚ï¼‰
    - cron: "*/15 2-17 * * *"
      env:
        MODE: light

    # ğŸŒ™ å¤œé–“3:30 JSTï¼ˆUTC 18:30ï¼‰ã«å…¨ä»¶ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    - cron: "30 18 * * *"
      env:
        MODE: full

  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ Pythonã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install requests jq

      - name: âš™ï¸ YouTubeãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
        id: runupdate
        env:
          YOUTUBE_KEY_MORE: ${{ secrets.YOUTUBE_KEY_MORE }}
          YOUTUBE_KEY_APOLLO: ${{ secrets.YOUTUBE_KEY_APOLLO }}
          YOUTUBE_KEY_MAHO: ${{ secrets.YOUTUBE_KEY_MAHO }}
          YOUTUBE_KEY_BIBI: ${{ secrets.YOUTUBE_KEY_BIBI }}
          YOUTUBE_KEY_RAMU: ${{ secrets.YOUTUBE_KEY_RAMU }}
          YOUTUBE_KEY_PICO: ${{ secrets.YOUTUBE_KEY_PICO }}
          YOUTUBE_KEY_SOCHIMARU: ${{ secrets.YOUTUBE_KEY_SOCHIMARU }}
        run: |
          echo "ğŸš€ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: ${{ env.MODE }}"
          python update.py --mode=${{ env.MODE }} > output.log 2>&1 || echo "failed" > fail.flag
          cat output.log

      - name: ğŸ’¾ JSONæ›´æ–°ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add data/streams.json data/streams_backup.json || true
          git commit -m "Auto update streams data (${{ env.MODE }} mode)" || true
          git push

      # âœ… æˆåŠŸã—ãŸã‚‰é€šçŸ¥ãƒ•ãƒ©ã‚°å‰Šé™¤ï¼ˆå†é€šçŸ¥ã‚’æœ‰åŠ¹åŒ–ï¼‰
      - name: ğŸ§¹ æˆåŠŸæ™‚ã«é€šçŸ¥ãƒ•ãƒ©ã‚°ã‚’å‰Šé™¤
        if: success()
        run: |
          if [ -f ".github/.notified" ]; then
            echo "âœ… æˆåŠŸã—ã¾ã—ãŸã€‚é€šçŸ¥ãƒ­ãƒƒã‚¯ã‚’è§£é™¤ã—ã¾ã™ã€‚"
            rm -f .github/.notified
          fi

      # ğŸ”” ã‚¨ãƒ©ãƒ¼æ™‚ï¼šDiscordã«æ—¥æœ¬èªEmbedã§é€šçŸ¥ï¼ˆé€£ç¶šæ™‚ã¯1å›ã ã‘ï¼‰
      - name: ğŸ”” ã‚¨ãƒ©ãƒ¼æ™‚ã«Discordé€šçŸ¥
        if: failure() || exists('fail.flag')
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ ! -f ".github/.notified" ]; then
            echo "âŒ Discordã«ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’é€ä¿¡ä¸­..."
            mkdir -p .github
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

            JSON_PAYLOAD=$(jq -n \
              --arg title "ğŸš¨ YouTubeæ›´æ–°ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ã¾ã—ãŸ" \
              --arg description "æ›´æ–°å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚" \
              --arg mode "${{ env.MODE }}" \
              --arg time "$TIMESTAMP" \
              --arg url "$RUN_URL" \
              '{
                "embeds": [
                  {
                    "title": $title,
                    "description": $description,
                    "color": 15158332,
                    "fields": [
                      {"name": "ãƒ¢ãƒ¼ãƒ‰", "value": $mode, "inline": true},
                      {"name": "ç™ºç”Ÿæ™‚åˆ»", "value": $time, "inline": true},
                      {"name": "ãƒ­ã‚°ã‚’ç¢ºèª", "value": $url}
                    ],
                    "footer": {"text": "è‡ªå‹•ç›£è¦–: GitHub Actions"}
                  }
                ]
              }')

            curl -X POST -H "Content-Type: application/json" -d "$JSON_PAYLOAD" "$DISCORD_WEBHOOK_URL"
            touch .github/.notified
          else
            echo "âš ï¸ ã™ã§ã«é€šçŸ¥æ¸ˆã¿ã€‚é‡è¤‡é€ä¿¡ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi
